---
layout: post
comments: true
title:  "Magisk for xiaomi (unofficial) treble device"
date:   2018-04-11 0:30:00 +0700
author: Dede Dindin Qudsy
last_modified_at: 2018-07-17 15:41:00 +0700
---
For xiaomi devices with unofficial support of treble, it use unused `/cust` partition as `/vendor` partititon. As Magisk mount `/vendor` partition, it mount partition with name vendor, this won't work on xiaomi devices with unofficial support of treble as it didn't have `/vendor` partition.

As workaround till topjohnwu came with official support for xiaomi unofficial treble devices, we rename vendor to cust in `magiskinit.c` so it will mount `/cust` partition as vendor.

not there's pull request by TheScarastic about mount cust as vendor [link](https://github.com/topjohnwu/Magisk/pull/373/) now we shall wait until it merge to magisk.

```diff
From 7825baf828da3f6f0eefbb4ae5321828b2e91f37 Mon Sep 17 00:00:00 2001
From: TheScarastic <warabhishek@gmail.com>
Date: Sat, 21 Apr 2018 19:01:12 +0530
Subject: [PATCH] Use more generic way to mount vendor

 * Should fix issues with devices mounting some unused partiton as vendor
---
 native/jni/core/magiskinit.c | 15 ++++++++++++++-
 1 file changed, 14 insertions(+), 1 deletion(-)

diff --git a/native/jni/core/magiskinit.c b/native/jni/core/magiskinit.c
index c24e80e0..09ff931a 100644
--- a/native/jni/core/magiskinit.c
+++ b/native/jni/core/magiskinit.c
@@ -428,11 +428,24 @@ int main(int argc, char *argv[]) {
 	if (cmd.skip_initramfs || access("/sepolicy", R_OK) != 0) {
 		char partname[32];
 		struct device dev;
+		char vendor[10];
+		char vendorpath[128];
+		int fd;
 
 		// Mount sysfs
 		mkdir("/sys", 0755);
 		xmount("sysfs", "/sys", "sysfs", 0, NULL);
 
+		// Check if device uses early-mount
+		if (access("/sys/firmware/devicetree/base/firmware/android/fstab/vendor/dev", R_OK) == 0) {
+			fd = open("/sys/firmware/devicetree/base/firmware/android/fstab/vendor/dev", O_RDONLY | O_CLOEXEC);
+			vendorpath[read(fd, vendorpath, sizeof(vendorpath))] = '\0';
+			strcpy(vendor, strrchr(vendorpath, '/') + 1);
+			close(fd);
+		} else
+			strcpy(vendor, "vendor");
+
+
 		// Mount system
 		snprintf(partname, sizeof(partname), "system%s", cmd.slot);
 		setup_block(&dev, partname);
@@ -453,7 +466,7 @@ int main(int argc, char *argv[]) {
 		}
 
 		// Mount vendor
-		snprintf(partname, sizeof(partname), "vendor%s", cmd.slot);
+		snprintf(partname, sizeof(partname), "%s%s", vendor, cmd.slot);
 		if (setup_block(&dev, partname) == 0)
 			xmount(dev.path, "/vendor", "ext4", MS_RDONLY, NULL);
 	}
```

This is just self compiled Magisk with above code applied.

Stable build :
 - [v16.0](https://drive.google.com/a/my.smccd.edu/uc?id=1zb_2Z4S2x5291ZXtfMhcNI01u2UDDKrR&export=download) by [abhishek987](https://forum.xda-developers.com/member.php?u=6070905)

Beta build :
 - [v16.3(1650)](https://www.dropbox.com/s/c0pkqvdwjikypke/Magisk-v16.3-cust.zip?dl=0)
 - [v16.3(1660)](https://www.dropbox.com/s/mwv04ge2br19knc/Magisk-v16.3%281660%29.zip?dl=0)
 - [v16.4(1642)](https://www.dropbox.com/s/2hua5u3zhgm1rqo/Magisk-v16.4.zip?dl=0)
 - [v16.4(1643)](https://www.dropbox.com/s/1uzzvljurqzz8pt/Magisk-v16.4%281643%29.zip?dl=0)
 - [v16.6(1664)](https://www.androidfilehost.com/?fid=5862345805528050384)
